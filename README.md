# dcc - a dependency-driven C/C++ compiler driver

`dcc` is a C/C++ compiler driver _wrapper_ that that adds, parallel,
_dependency based builds_ to the underlying C or C++ compiler.

`dcc` uses compiler generated dependency information along with
hard-coded `make`-like rules to determine if compilation, or linking,
is actually required.  Like a `make`-based build `dcc` only
re-compiles or re-links if an output file is out-of-date with respect
to dependencies and needs to be recreated.

The result of moving this work into the compiler driver itself is
simpler build systems. Much of the work done by tools such as `make`
is now performed in a single command, e.g. `dcc *.c`.

Instead of using the build tool to express and maintain
dependencies that job can be relegated to `dcc` and the
build tool used to express higher level concerns such as
what to build and what options to use when building it.

## Usage

`dcc` usage is similar to that of `cc(1)`, `gcc(1)` and similar
compiler drivers,

    $ dcc <option...> <pathname...>

Like `cc` et al `dcc` compiles source files to object files using the
options passed on the command line. If a `-c` is passed `dcc` stops
following compilation but if no `-c` option is supplied `dcc` runs the
linker to form an executable from the object files.

However unlike `cc` et al `dcc` automatically generates and uses
dependencies and only compiles or links if an output file needs to be
re-created. Apart from re-compilation being far faster when files are
_not_ re-compiled the effect of this is transparent to the end-user.

`dcc` can be used as a mostly _drop in_ replacement for `cc/c++(1)` in
existing build systems. Doing so adds additional dependency checking
to builds. There is a difference in behaviour with respect to existing
compiler drivers that may affect results, `dcc` does *not* remove
object files when no `-c` switch is used. Most build systems however
invoke the compiler for each source file passing `-c`.


## What dcc does

`dcc` _wraps_ the underlying compiler driver and passes it options to
have it output dependency information. `dcc` automaticlaly determines
the names of the files storing this information and reads the files
when re-compiling a file.

When re-compiling a file `dcc` performs make-like dependency checking
using the compiler-generated information to determine if compilation
is actually required. If not `dcc` does nothing and exits as if it had
compiled the file (note, the file modification time is *not* altered).
Dependency generation and checking is transparent to the end-user.
Additionally, `dcc` implements dependency checking on the libraries
and other files used in building.


## Command line options

The `dcc` command line consists of options for the underling compiler,
a number of `dcc`-specific options and filenames to be processed.

Options to the compiler are passed through unalterted. `dcc` does
recognize a number of options which control its behaviour or supply
dependency information (libraries).

### dcc-specific options

These options apply to `dcc` itself and are not passed on to the
compiler,

- --help 
  Get help.
- --debug 
  Enable `dcc` debug output.
- --clean 
  Remove `dcc`-generated files.
- --cpp 
  Compile source as C++ rather than C.
- --force 
  Rebuild everything, ignore dependencies.
- --quiet 
  Don't output the commands being executed.
- --exe <path> 
  Compile and link an executable called <path>.
- --dll <path> 
  Compile and create a shared library called <path>.
- --lib <path> 
  Compile and create a static library, <path>.
- -j<number> 
  Use <number> parallel compilations.

### --exe, --dll, --lib

`cc`-style compiler drivers traditionally worked in two modes. They
either compiled source files to object files or did that and linked
the object files to form an executable (and removed the object files).
Shared libraries added options to have the linker create a shared
library but the overall structure is the same as for an executable.

`dcc` has options that make these uses more explicit and adds the
feature of having the compiler driver generate a static library to
round out the various use cases.

The `dcc`-specific `--exe`, `--dll` and `--lib` options are used to
tell `dcc` what is being built and the name of the output file.

The `--exe` option means "build an executable", `--dll` means "build a
shared library" (sic) and `--lib` means "build a static library".

### Language selection

`dcc` determines the language being compiled, C or C++, using a number
of rules. C++ is selected if,

- if the name used to invoke `dcc` ends with `++`
- a source file name has a C++ extension `.cc`, `.cpp`, `.cxx`
- the `--cpp` switch was supplied



## Depenencies

`dcc` uses dependency information generated by the compiler itself
and information inferred from the filenames and system environment.

With gcc-style compilers `dcc` uses the `-MF` and `-MD` options to
have the compiler output make-format dependencies to a file which
`dcc` reads on the next run.

Dependency files are stored in a `.dcc.d` directory that resides in
the same directory as the object file being created. The `DCCDEPS`
environment variable can be set to use a name other than `.dcc.d` for
this directory.


### Rules

`dcc` compiles a source file if one or more of the following is true,

- the object file does not exist
- the source file is newer than the object file
- compiler options have changed (see below)
- there is no dependency file for the object file
- a dependent file is newer than the object file
- the --force command-line option was supplied

Otherwise the source  file does  not require _re-compilation_.


## Differences to cc

Although `dcc` is similar in usage to cc(1) et al, enough so to permit
it to be used directly in their place, it does have a number of
behavioral differences.

### object files without `-c`

`dcc` behaves differently to `cc` in the abscence of the `-c` option.

Normally, without `-c` `cc` will compile the source files, generating
object files, run the linker to create an executable from those object
files and then *remove* the object files.

`dcc` does not remove the object files as they are required to
implement re-compilation.

### concurrent compilation

When passed more than one source file `dcc` compiles more than one
file at a time.

### options files

`dcc` can read compiler and linker options and libraries from files.

## Options files

`dcc` can read compiler and linker options stored in files called
_options files_. Options files are text files that contain options
that would normally be passed on the command line.

Unlike passing options via the the comand line options files permit
options to be split across multiple lines and support '#'-based _line_
comments. Options files are also treated as dependencies so that
changing an options file, and presumably the options it contains,
results in recompilation.  This feature is handy when using
pre-compiled header files or non-standard compilation options and
ensures all files are built in the same way.

- `CFLAGS` 
  C compiler options.
- `CXXFLAGS` 
  C++ compiler options.
- `LDFLAGS` 
  Linker options.
- `LIBS` 
  Libraries and library paths.


### Locating options files

Option files are stored within a $DCCDIR directory located in the
current directory or in some directory higher in the directory
hierarchy.

If $DCCDIR is not set the directory `.dcc` is used if it exists
otherwise the current directory `.` is used. Looking for the files in
a `.dcc` directory is a quick hack to get the files out of the current
directory and in the future some other method may be adopted (ha ha).

### Platform-specific options

`dcc` uses a Go-inspired method to support platform-specific options.

When searching for an options file `dcc` first searches for platform
and architecture specific variants of the file. `dcc` forms a file
name extension using names for for the host's architecture and
operating system and appends that extension to the filename. If a file
with that name exists it is used in place of the unadorned filename.

E.g. when searching for the `LIBS` file on a 64-bit FreeBSD host
the following files will be searched for in order,

1. `$DCCDIR/LIBS.freebsd_amd64`
2. `$DCCDIR/LIBS.freebsd`
3. `$DCCDIR/LIBS`

### Libraries

The `LIBS` options file is used to define the libraries and library
directories used when linking programs and DLLs.

The `LIBS` options file behaves in a similar manner to the compiler
options and executables depend on the file and relink when it changes.

Lines starting with `-l` (elle) and `-L` (capital-elle) are special.
Any library name starting with `-l` has the `-l` removed allowing
users to use UNIX linker-style naming for familarity. _libraries_ with
names starting with `-L` are the names of of library directories.


## Implementation

`dcc` is written in Go and uses only standard packages in its
implementation. `dcc` should build in any supported Go environment and
be trivially cross-buildable.

`dcc` itself supports the various Linux distribtions, the BSD's, MacOS
and mostly likely other UNIX systems that use gcc, clang or
similar.

`dcc` has not really been used _in anger_ and I expect many changes
if it is used more extensively.

## License

`dcc` is  released under  the GPL,  version 2. If  you advance  dcc, and
distribute, you must share the  advancements. The reasoning being that
a  utility such  as dcc  is infrastructure  and we  should share,  and
advance, infrastructure so we all get ahead.

As per convention the license text is in the file LICENSE.
